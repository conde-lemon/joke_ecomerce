<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Prueba: Pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="user-email" th:content="${emailFilter}"/>
</head>
<body class="p-4">
<div class="container">
  <h3 class="mb-3">Página de prueba — Pedidos</h3>

  <form class="row g-2 mb-3" method="get" th:action="@{/test/orders}">
    <div class="col-auto">
      <input type="text" name="email" th:value="${emailFilter}" class="form-control" placeholder="Filtrar por email (ej: user@example.com)"/>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filtrar</button>
      <a class="btn btn-outline-secondary" th:href="@{/test/orders}">Limpiar</a>
    </div>
  </form>

  <div th:if="${emailFilter != null and emailFilter != ''}" class="mb-2">
    <small>Mostrando pedidos para: <strong th:text="${emailFilter}">email</strong></small>
  </div>

  <div th:if="${error}" class="alert alert-danger">
    <strong>Error al consultar pedidos en servidor:</strong>
    <pre th:text="${error}">Mensaje de error</pre>
  </div>

  <div class="mb-3">
    <a class="btn btn-outline-primary" th:href="@{/api/test/orders(email=${emailFilter})}" target="_blank">Abrir /api/test/orders (JSON)</a>
    <button id="btnFetch" class="btn btn-primary ms-2">Probar fetch desde navegador</button>
    <button id="btnAxios" class="btn btn-secondary ms-2">Probar axios desde navegador</button>
  </div>

  <div class="mb-3">
    <small class="text-muted">Pedidos encontrados: <strong th:text="${count}">0</strong></small>
  </div>

  <div th:if="${orders != null and orders.size() > 0}" class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th class="text-end">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="o : ${orders}">
          <td th:text="${o.id}">1</td>
          <td th:text="${o.estado}">CREADO</td>
          <td th:text="${o.fechaPedido != null ? #temporals.format(o.fechaPedido, 'dd/MM/yyyy HH:mm') : '-'}">-</td>
          <td class="text-end" th:text="${o.total}">0.00</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="result" class="mt-4"></div>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  const resultEl = document.getElementById('result');

  document.getElementById('btnFetch').addEventListener('click', async () => {
    resultEl.innerHTML = '<div class="spinner-border" role="status"></div> Ejecutando fetch...';
    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);
      const res = await fetch('/api/test/orders', { signal: controller.signal, credentials: 'include' });
      clearTimeout(timeout);
      const text = await res.text();
      resultEl.innerHTML = '<h5>Respuesta fetch</h5><pre>' + escapeHtml(text) + '</pre>';
    } catch (err) {
      resultEl.innerHTML = '<div class="alert alert-danger"><strong>Error fetch:</strong> ' + (err.message || err) + '</div>';
      console.error('fetch error', err);
    }
  });

  document.getElementById('btnAxios').addEventListener('click', async () => {
    resultEl.innerHTML = '<div class="spinner-border" role="status"></div> Ejecutando axios...';
    try {
      const res = await axios.get('/api/test/orders', { timeout: 8000 });
      resultEl.innerHTML = '<h5>Respuesta axios (JSON)</h5><pre>' + JSON.stringify(res.data, null, 2) + '</pre>';
    } catch (err) {
      const msg = err && err.message ? err.message : String(err);
      resultEl.innerHTML = '<div class="alert alert-danger"><strong>Error axios:</strong> ' + msg + '</div>';
      console.error('axios error', err);
    }
  });

  function escapeHtml(s) {
    return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }
</script>
</body>
</html>
