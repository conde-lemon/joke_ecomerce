<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Carrito de Compras</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100">
<div data-th-replace="~{fragments/navbar :: navbar}"></div>

<main class="container my-4 flex-grow-1">
  <h3 class="mb-3">Carrito de Compras</h3>

  <div data-th-if="${msg}" class="alert alert-success" data-th-text="${msg}"></div>

  <div data-th-if="${cart == null or #lists.isEmpty(cart.items)}" class="alert alert-info">Tu carrito está vacío.</div>

  <div data-th-if="${cart != null and not #lists.isEmpty(cart.items)}">
    <table class="table align-middle">
      <thead class="table-light">
      <tr>
        <th style="width:120px">Producto</th>
        <th>Nombre</th>
        <th style="width:200px">Cantidad</th>
        <th style="width:160px" class="text-end">Precio unitario</th>
        <th style="width:160px" class="text-end">Subtotal</th>
        <th style="width:120px"></th>
      </tr>
      </thead>
      <tbody>
      <tr data-th-each="item : ${cart.items}">
        <td>
          <img data-th-src="${item.product.imageUrl}" class="img-thumbnail" style="width:100px;height:auto" alt="prod">
        </td>
        <td>
          <a class="fw-semibold text-decoration-none" th:href="@{'/product/' + ${item.product.id}}" data-th-text="${item.product.nombre}">Nombre del Producto</a>
        </td>
        <td>
          <form data-th-action="@{'/cart/update/' + ${item.product.id}}"
                method="post"
                class="d-flex align-items-center gap-2">

            <div class="input-group qty-group">
              <button class="btn btn-outline-secondary btn-qty" type="button" data-delta="-1" aria-label="Restar">−</button>
              <input type="text"
                     name="qty"
                     inputmode="numeric"
                     pattern="[0-9]*"
                     class="form-control qty-input text-center"
                     th:value="${item.qty}">
              <button class="btn btn-outline-secondary btn-qty" type="button" data-delta="1" aria-label="Sumar">＋</button>
            </div>
            <button type="submit" class="btn btn-sm btn-outline-primary">Actualizar</button>
          </form>
        </td>
        <td class="text-end">S/ <span data-th-text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 2, 'POINT')}">0.00</span></td>
        <td class="fw-semibold text-end">S/ <span data-th-text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 2, 'POINT')}">0.00</span></td>
        <td class="text-end">
          <form data-th-action="@{'/cart/remove/' + ${item.product.id}}" method="post">
            <button type="submit" class="btn btn-sm btn-outline-danger">Quitar</button>
          </form>
        </td>
      </tr>
      </tbody>
      <tfoot>
      <tr>
        <th colspan="4" class="text-end">Subtotal (<span data-th-text="${cart.totalItems}">0</span> items)</th>
        <th class="fw-bold text-end">S/ <span data-th-text="${#numbers.formatDecimal(cart.subtotal, 0, 'COMMA', 2, 'POINT')}">0.00</span></th>
        <th></th>
      </tr>
      </tfoot>
    </table>

    <div class="d-flex justify-content-between mt-4">
      <a class="btn btn-outline-secondary" data-th-href="@{/catalog}">Seguir comprando</a>
      <div class="d-flex gap-2">
        <form data-th-action="@{/cart/clear}" method="post">
          <button class="btn btn-outline-danger">Vaciar carrito</button>
        </form>
        <!-- Esta es la conexión principal con checkout.html -->
        <a class="btn btn-primary" data-th-href="@{/checkout}">Ir a pagar</a>
      </div>
    </div>
  </div>
</main>

<div data-th-replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.querySelectorAll('.qty-input').forEach(inp => {
    inp.addEventListener('input', () => {
      const m = inp.value.match(/\d+/);
      inp.value = m ? m[0] : '';
    });
    inp.addEventListener('blur', () => {
      if (inp.value === '') inp.value = '0';
    });
  });

  document.querySelectorAll('.btn-qty').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = btn.closest('.qty-group').querySelector('.qty-input');
      const delta = parseInt(btn.dataset.delta || '0', 10);
      const current = parseInt(input.value || '0', 10);
      const next = Math.max(0, current + delta);
      input.value = String(next);
    });
  });
</script>

</body>
</html>